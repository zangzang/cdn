<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DevExtreme DataGrid 실시간 업데이트</title>
  
  <!-- DevExtreme CSS -->
  <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/25.1.7/css/dx.light.css">
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    .inc {
      color: #2ab71b;
    }
    
    .dec {
      color: #f00;
    }

    .row-flash {
      animation: rowFlash 3s ease-out;
    }

    @keyframes rowFlash {
      from {
        background-color: #e8f5e8;
      }
      to {
        background-color: transparent;
      }
    }

    /* 업데이트된 셀 하이라이트 색상 오버라이드 */
    .dx-datagrid-cell-updated-animation {
      animation: cellUpdateFlash 1s ease-out !important;
    }

    @keyframes cellUpdateFlash {
      0% {
        background-color: #ffa500;
      }
      100% {
        background-color: transparent;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>DevExtreme DataGrid 실시간 업데이트</h1>
    <button id="testBtn">자동 시작</button>
    <div id="gridContainer"></div>
  </div>

  <!-- DevExtreme 라이브러리 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn3.devexpress.com/jslib/25.1.7/js/dx.all.js"></script>

  <script>
    // 로컬 데이터 저장
    let localData = [
      { id: 1, name: '상품 A', price: 10000, quantity: 50, status: 'active' },
      { id: 2, name: '상품 B', price: 25000, quantity: 30, status: 'active' },
      { id: 3, name: '상품 C', price: 15000, quantity: 20, status: 'inactive' }
    ];

    // CustomStore 생성
    const store = new DevExpress.data.CustomStore({
      key: 'id',
      load: function() {
        return Promise.resolve(localData);
      },
      insert: function(values) {
        const newItem = { ...values, id: Math.max(...localData.map(item => item.id)) + 1 };
        localData.unshift(newItem); // 상단에 추가
        return Promise.resolve(newItem);
      },
      update: function(key, values) {
        const index = localData.findIndex(item => item.id === key);
        if (index !== -1) {
          localData[index] = { ...localData[index], ...values };
          return Promise.resolve(localData[index]);
        }
        return Promise.reject(new Error('Item not found'));
      }
    });

    // DataGrid 초기화
    const dataGrid = $('#gridContainer').dxDataGrid({
      dataSource: store,
      showBorders: true,
      repaintChangesOnly: true,  // 변경된 부분만 다시 그리기
      highlightChanges: true,     // 변경 사항 강조 표시
      onRowPrepared: function(e) {
        // 새로 추가된 row ID Set에서 확인하고 애니메이션 적용
        if (e.rowType === 'data' && e.data && newlyInsertedIds.has(e.data.id)) {
          e.rowElement.addClass('row-flash');
          newlyInsertedIds.delete(e.data.id); // 적용 후 제거
        }
      },
      columns: [
        { 
          dataField: 'id', 
          caption: 'ID',
          width: 80
        },
        { 
          dataField: 'name', 
          caption: '이름'
        },
        { 
          dataField: 'price', 
          caption: '가격',
          format: '#,##0원',
          dataType: 'number',
          cellTemplate: function(container, options) {
            const value = options.value;
            const oldValue = options.oldValue;
            const cssClass = oldValue && value > oldValue ? 'inc' : 
                           oldValue && value < oldValue ? 'dec' : '';
            container.html(`<span class="${cssClass}">${value.toLocaleString()}원</span>`);
          }
        },
        { 
          dataField: 'quantity', 
          caption: '수량',
          dataType: 'number'
        },
        { 
          dataField: 'status', 
          caption: '상태',
          cellTemplate: function(container, options) {
            const isActive = options.value === 'active';
            const bgColor = isActive ? '#d4edda' : '#f8d7da';
            const color = isActive ? '#155724' : '#721c24';
            const text = isActive ? '활성' : '비활성';
            container.html(
              `<span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                font-weight: 500; background: ${bgColor}; color: ${color};">${text}</span>`
            );
          }
        }
      ]
    }).dxDataGrid('instance');

    // 자동 업데이트/추가 (간소화 버전)
    let nextId = Math.max(...localData.map(item => item.id)) + 1;
    let isRunning = false;
    let intervalId = null;
    const newlyInsertedIds = new Set(); // 새로 추가된 row ID 추적
    
    function performRandomUpdate() {
      if (Math.random() > 0.5) {
        // 새 항목 추가
        const newItem = {
          id: nextId++,
          name: `상품 ${String.fromCharCode(64 + nextId)}`,
          price: Math.floor(Math.random() * 50000) + 5000,
          quantity: Math.floor(Math.random() * 100),
          status: Math.random() > 0.5 ? 'active' : 'inactive'
        };
        
        newlyInsertedIds.add(newItem.id); // 애니메이션 대기 목록에 추가
        localData.unshift(newItem);
        store.push([{ type: 'insert', data: newItem, index: 0 }]);
      } else {
        // 기존 항목 업데이트
        if (localData.length === 0) return;
        
        const randomItem = localData[Math.floor(Math.random() * localData.length)];
        const updates = {
          price: Math.floor(Math.random() * 50000) + 5000,
          quantity: Math.floor(Math.random() * 100),
          status: Math.random() > 0.5 ? 'active' : 'inactive'
        };

        const index = localData.findIndex(item => item.id === randomItem.id);
        if (index !== -1) {
          localData[index] = { ...localData[index], ...updates };
          store.push([{ type: 'update', key: randomItem.id, data: updates }]);
        }
      }
    }
    
    $('#testBtn').on('click', function() {
      isRunning = !isRunning;
      
      if (isRunning) {
        $(this).text('자동 중지');
        performRandomUpdate(); // 즉시 실행
        intervalId = setInterval(performRandomUpdate, 800); // 0.8초마다 실행
      } else {
        $(this).text('자동 시작');
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
        }
      }
    });
  </script>
</body>
</html>